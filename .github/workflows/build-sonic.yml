name: Build SONiC for QFX5200

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-sonic:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source (as root)
        uses: actions/checkout@v4

      - name: Set up build container with non-root user
        uses: addnab/docker-run-action@v3
        with:
          image: sonicdev-microsoft.azurecr.io/sonic-slave-buster:latest
          options: -u 1000  # run as UID 1000 (builder)
          shell: bash
          run: |
            # Fix apt sources due to Debian Buster EOL
            sudo sed -i 's|http://deb.debian.org/debian|http://archive.debian.org/debian|g' /etc/apt/sources.list
            sudo sed -i 's|http://security.debian.org/debian-security|http://archive.debian.org/debian-security|g' /etc/apt/sources.list
            sudo sed -i '/^deb.*updates/d' /etc/apt/sources.list
            sudo apt-get update -o Acquire::Check-Valid-Until=false
            sudo apt-get install -y make g++ curl git

            # Configure and build
            make init
            make configure PLATFORM=juniper_qfx5200_32c
            make all
